{% extends 'collage/base.html' %}



{% block content %}
    {% load static %}
    <script type="text/javascript" src="{% static  'collage/jquery-3.4.0.js' %}"></script>
    <script src="{% static 'celery_pb/celery_progress.js' %}"></script>
    <script>

        $(document).ready(function () {
            $('#collage_form').submit(function () { // catch the form's submit event
                $.ajax({ // create an AJAX call...
                    data: $(this).serialize() + "&query_type=" + "collage_launch", // get the form data
                    type: $(this).attr('method'), // GET or POST
                    url: $(this).attr('action'), // the file to call
                    success: function (response) { // on success..
                        $("#some_text")[0].textContent += '&'
                        {#$('#DIV_CONTAINING_FORM').html(response); // update the DIV#}
                    }
                });
                return false;
            });


            $('#button_progress_launch').click(function () {
                {#alert('alert!')#}
                $.ajax({
                    type: "POST",
                    url: "{% url 'collage:input' %}",
                    data: {
                        csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                        query_type: 'progress_launch'
                    },

                    success: function (data_celery_url) {
                        var progressUrl = data_celery_url;
                        CeleryProgressBar.initProgressBar(progressUrl)
                    },
                });

            })
        })
    </script>

    {% csrf_token %}
    <input id="input_count" type="number" value="1" min="1" max="10000"></p>
    <input id="button_do_it" type="button" value="Отправить" onclick="doIt()">
    <input id="button_progress_launch" type="button" value="Запустить прогресс">

    <form id="collage_form" action="{% url 'collage:input' %}" method="post">
        {% csrf_token %}
        {{ collage_input.as_p }}

        <div class="spinner-border" role="status" id="spinner">
            <span class="sr-only">Loading...</span>
        </div>

        <br>
        <input id="submit" type="submit" value="OK">
        {#        <input id="button_collage_launch" type="submit" value="OK" onclick="collage_launch()">#}
        {#    <button class="btn btn-primary" type="button" disabled>#}
        {#  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>#}
        {#  Loading...#}
        {#</button>#}
        <div id="DIV_CONTAINING_FORM">
            div<br>
        </div>
    </form>

    <div id="some_text">
        {% if  some_text %}
            {{ some_text }}
        {% else %}
            No texts
        {% endif %}

    </div>
    <div class='progress-wrapper'>
        <div id='progress-bar' class='progress-bar' style="background-color: #68a9ef; width: 0%;">&nbsp;</div>
    </div>
    <div id="progress-bar-message">Waiting for progress to start...</div>

    {#----------------JAVASCRIPT---------------------------------------#}
    <script>

        $(document).ready(function () {
            $("#spinner").css("-webkit-animation-play-state", "paused");
        })

        $('#submit').click(function () {
            //alert('clicked')
            $("#spinner").css("-webkit-animation-play-state", "running");
            setTimeout(myPeriodicMethod, 100);
            //$("#some_text")[0].textContent += 'xx'
        })

        function myPeriodicMethod() {
            //$("#some_text")[0].textContent += 1

            $.ajax({
                type: "POST",
                url: "{% url 'collage:input' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    query_type: 'poll'
                },
                success: function (data) {
                    $("#some_text")[0].textContent += '.'
                    //alert('Now and then')
                },
                complete: function () {
                    // schedule the next request *only* when the current one is complete:
                    setTimeout(myPeriodicMethod, 200);
                }
            });
            //$("#some_text")[0].textContent += 1
        }


    </script>


{% endblock %}
