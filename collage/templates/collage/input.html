{% extends 'collage/base.html' %}



{% block content %}
    {% load static %}
    <script type="text/javascript" src="{% static  'collage/jquery-3.4.0.js' %}"></script>
    <script>
        function doIt() {
            $.ajax({
                type: "POST",
                url: "{% url 'collage:async' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    count: $("#input_count").val()
                },
                success: function (data) {
                    alert("Процесс запущен! {{user.username}}");
                },
                error: function (xhr, textStatus, errorThrown) {
                    alert("Error: " + errorThrown + xhr.status + xhr.responseText);
                }
            });
        }


    </script>

    {% csrf_token %}
    <input id="input_count" type="number" value="1" min="1" max="10000"></p>
    <input id="button_do_it" type="button" value="Отправить" onclick="doIt()">

    <form action="{% url 'collage:input' %}" method="post">
        {% csrf_token %}
        {{ collage_input.as_p }}

        <div class="spinner-border" role="status" id="spinner">
            <span class="sr-only">Loading...</span>
        </div>

        <br>
{#        <input id="submit" type="submit" value="OK">#}
        <input id="button_collage_launch" type="submit" value="OK" onclick="doIt2()">
        {#    <button class="btn btn-primary" type="button" disabled>#}
        {#  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>#}
        {#  Loading...#}
        {#</button>#}

    </form>

    <div id="some_text">
        {% if  some_text %}
            {{ some_text }}
        {% else %}
            No texts
        {% endif %}

    </div>
    <script>
        $(document).ready(function () {
            $("#spinner").css("-webkit-animation-play-state", "paused");
        })

        $('#submit').click(function () {
            //alert('clicked')
            $("#spinner").css("-webkit-animation-play-state", "running");
            setTimeout(myPeriodicMethod, 100);
            //$("#some_text")[0].textContent += 'xx'
        })

        function myPeriodicMethod() {
            //$("#some_text")[0].textContent += 1

            $.ajax({
                type: "POST",
                url: "{% url 'collage:input' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    mode: 'poll'
                },
                success: function (data) {
                    $("#some_text")[0].textContent += 2
                    //alert('Now and then')
                },
                complete: function () {
                    // schedule the next request *only* when the current one is complete:
                    setTimeout(myPeriodicMethod, 100);
                }
            });
            //$("#some_text")[0].textContent += 1
        }


    </script>

{% endblock %}
